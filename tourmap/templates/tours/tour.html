{% extends "base.html" %}
{% block head %}
    {{ super() }}
    {% assets "map_js" %}
        <script type="text/javascript" src="{{ ASSET_URL }}"></script>
    {% endassets %}
    {% assets "map_css" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}"/>
    {% endassets %}
{% endblock %}
{% block title %}{{ tour.name }} - by {{ user.firstname }}{% endblock %}
{% block content %}
<h3>{{ tour.name }} by {{ user.firstname }}</h3>
<div class="row">
  <div id="mappos" class="col-sm-12">
      <div id="mapid"></div>
  </div>
</div>
    <script>
    // XXX: We put all data into the returned HTML. Alternative would
    //      be AJAX, I guess.
    var activities = {{ activities|tojson|safe }};
    </script>

    <!-- this is where all the mess starts...
        XXX: move into a separate file!
    -->
    <script>

        var map = L.map('mapid');
        var setViewDone = false;
        if (activities.length > 0) {
            for (let a of activities) {
                var latlngs = a["latlngs"]
                if (latlngs.length > 0) {
                    var lat = latlngs[latlngs.length - 1][0];
                    var lng = latlngs[latlngs.length - 1][1];
                    map.setView([lat, lng], 6);
                    setViewDone = true;
                    // console.log("setView done!")
                    break;
                }
            }
        }
        if (!setViewDone) {
            console.log("setView fallback!")
            map.setView([42.48341, 78.40335], 4);
        }

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
            { maxZoom: 18,
              attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' + '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery Â© <a href="http://mapbox.com">Mapbox</a>', id: 'mapbox.streets' }).addTo(map);

        /* L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
                    maxZoom: 18, }).addTo(map); */

        function createPopupElementForActivity(a, photoColumns, photoFactor) {
            var maxImgWidth = 0;
            var popupRoot = document.createElement("div");
            $(popupRoot).addClass("activity-popup");
            var popupTitle = document.createElement("h5");
            $(popupTitle).text(a["name"])
            $(popupRoot).append(popupTitle);

            var popupDesc = document.createElement("div");
            $(popupRoot).append(popupDesc);

            // Ugh, table...
            var imgTable = document.createElement("table");
            $(imgTable).addClass("photos-table");

            var imgTbody= document.createElement("tbody");
            $(imgTable).append(imgTbody);

            var imgTr = null;
            var i = 0;
            a["photos"].forEach(function(p) {
                if (i % photoColumns == 0) {
                    imgTr = document.createElement("tr");
                    $(imgTbody).append(imgTr);
                }
                var imgTd = document.createElement("td");
                $(imgTd).addClass("photo-table-cell");
                $(imgTr).append(imgTd)
                var img = document.createElement("img");
                $(imgTd).append(img);
                img.setAttribute("data-url", p["url"]);
                img.setAttribute("data-large-url", p["large"]["url"]);

                img.setAttribute("width", parseInt(p["width"] * photoFactor));
                img.setAttribute("height", parseInt(p["height"] * photoFactor));
                $(img).addClass("img-rounded")

                // Allow fullscreen
                $(img).click(function() {
                    var url = $(this).attr("data-large-url");
                    var width = $(this).attr("data-large-width");
                    var height = $(this).attr("data-large-height");
                    console.log("Clicked image... url=" + url);
                    $("#fullscreen-img").attr("src", url);
                    $("#fullscreen-img").attr("width", width);
                    $("#fullscreen-img").attr("height", height);
                    console.log("Set fullscreen-img src, I think...");
                    $("#wholebody").fadeOut(function() {
                        $("#fullscreen").fadeIn();
                    });
                });

                maxImgWidth = Math.max(maxImgWidth, parseInt(p["width"] * photoFactor));
                i++;
            });


            $(popupRoot).append(imgTable);

            popupRoot.setAttribute("data-max-width", maxImgWidth * photoColumns);

            return popupRoot;
        }

        for (let a of activities) {

            var latlngs = a["latlngs"];
            polyline = L.polyline(latlngs, {
                color: 'teal',
                weight: 8
            })
            polyline.addTo(map);
        }

        // Register resize event to update the map size.
        // This is pretty nasty...
        $(window).resize(map, function() {
            var nav_height = $("#navigation").outerHeight(true); /* include margin */
            var map_pos = $("#mappos").position();
            window.map_pos = map_pos;
            // console.log("map_pos=" + map_pos + "map_pos.top=" + map_pos.top);
            var footer_height = $("#footer").outerHeight(true);

            var window_height = $(window).height();
            var new_height = Math.max(window_height - map_pos.top - footer_height - 20, 100);
            var old_height = map.getSize().y
            // console.log("window_height=" + window_height  + " new_height=" + new_height + " old_height=" + old_height + " nav_height=" + nav_height + " footer_height=" + footer_height);
            if (new_height != old_height) {
                $("#mapid").height(new_height);
                map.invalidateSize();
            }
        });

        var markers = [];

        function placeMarkers(bounds) {
            if (markers.length > 0) {
                return;
            }
            for (let a of activities) {
                var latlngs = a["latlngs"];
                marker = L.marker(latlngs[latlngs.length - 1]);
                markers.push(marker);

                // Ugly hack to downsize the photos and popups on small screens.
                if ($(window).width() > 600) {
                    var photoColumns = 2;
                    var photoFactor = 1.0;
                } else {
                    var photoColumns = 2;
                    var photoFactor = 0.5;
                }


                var content = createPopupElementForActivity(a, photoColumns, photoFactor);
                var popupWidth = content.getAttribute("data-max-width");
                var popup = L.popup({minWidth: "100", maxWidth: "auto"});
                popup.setContent(content);
                marker.bindPopup(popup);
                marker.addTo(map);
            }
        };

        function dropMarkers() {
            markers.forEach(function(m) {
                map.removeLayer(m);
            });
            markers.length = 0;
        }

        function toggleMarkers() {
            var level = map.getZoom();
            var bounds = map.getBounds();
            if (level >= 6) {
                placeMarkers();
            } else {
                dropMarkers();
            }
        }

        /* Register zoomed handler */
        map.on('zoomend', function() {
            toggleMarkers();
        });

        /*
         * On demand loading of images inside the popup. If we were
         * to create the <img> tags inside the popups from the beginning,
         * the browswer will fetch'em all, even if the popup is not open.
         */
        map.on('popupopen', function(e) {
            window.popupopenE = e.popup;
            $(e.popup.getContent()).find('img:not([src])').each(function() {
                $(this).attr("src", $(this).attr("data-url"));
            });
        });

        $("#fullscreen").click(function () {
            $(this).fadeOut(function() {
              $("#fullscreen-img").attr("src", "");
              console.log("Complete faseOut...")
              $("#wholebody").fadeIn();
            });
        });
    </script>
{% endblock %}
{% block after_body %}
    {{ super() }}
    <script>
        $(window).resize();
        toggleMarkers();
    </script>
{% endblock %}
